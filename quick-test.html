<!DOCTYPE html>
<html>
<head>
    <title>Quick Database Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Infinite Snake Database Test</h1>
    
    <div id="serverWarning" class="error" style="padding: 10px; background: #ffe0e0; border: 1px solid #ff0000; margin-bottom: 20px;">
        <strong>⚠️ Important:</strong> This file must be served through a web server, not opened directly.
        <br><br>
        <strong>To run the game:</strong>
        <ol>
            <li>Double-click the <code>start-server.command</code> file in this folder</li>
            <li>Open <a href="http://localhost:8000">http://localhost:8000</a> in your browser</li>
        </ol>
        <br>
        <strong>Alternative:</strong> Run this command in Terminal from this folder:<br>
        <code>python3 -m http.server 8000</code>
    </div>
    
    <div id="status">Testing database files...</div>
    <div id="results"></div>
    
    <script>
        // Test if we're running from file:// protocol
        if (window.location.protocol === 'file:') {
            document.getElementById('serverWarning').style.display = 'block';
        } else {
            document.getElementById('serverWarning').style.display = 'none';
        }
        
        async function testDatabase() {
            const status = document.getElementById('status');
            const results = document.getElementById('results');
            let html = '';
            
            // Test 1: Check essential database
            try {
                html += '<h2>1. Testing Essential Database</h2>';
                const response = await fetch('elements-essential.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Count elements
                let totalElements = 0;
                if (data.basicElements) totalElements += Object.keys(data.basicElements).length;
                if (data.tier1Elements) totalElements += Object.keys(data.tier1Elements).length;
                if (data.tier2Elements) totalElements += Object.keys(data.tier2Elements).length;
                
                html += '<div class="success">✓ Successfully loaded elements-essential.json</div>';
                html += `<ul>
                    <li>Basic Elements: ${Object.keys(data.basicElements || {}).length}</li>
                    <li>Tier 1 Elements: ${Object.keys(data.tier1Elements || {}).length}</li>
                    <li>Tier 2 Elements: ${Object.keys(data.tier2Elements || {}).length}</li>
                    <li>Total Elements: ${totalElements}</li>
                    <li>Combinations: ${Object.keys(data.combinations || {}).length}</li>
                </ul>`;
                
                // Show sample elements
                if (data.basicElements) {
                    html += '<p class="info">Sample basic elements:</p>';
                    html += '<pre>' + JSON.stringify(Object.keys(data.basicElements).slice(0, 4), null, 2) + '</pre>';
                }
                
            } catch (error) {
                html += '<div class="error">✗ Failed to load elements-essential.json</div>';
                html += '<div class="error">Error: ' + error.message + '</div>';
                
                if (window.location.protocol === 'file:') {
                    html += '<div class="error"><strong>This appears to be a CORS error because you opened the file directly.</strong></div>';
                }
            }
            
            // Test 2: Check manifest
            try {
                html += '<h2>2. Testing Manifest</h2>';
                const response = await fetch('elements-database-consolidated.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                html += '<div class="success">✓ Successfully loaded elements-database-consolidated.json</div>';
                html += '<p class="info">Available chunks:</p>';
                html += '<ul>';
                
                if (data.chunkManifest) {
                    for (const [id, chunk] of Object.entries(data.chunkManifest)) {
                        html += `<li>${id}: ${chunk.file} (${chunk.elementCount} elements)</li>`;
                    }
                }
                html += '</ul>';
                
            } catch (error) {
                html += '<div class="error">✗ Failed to load manifest</div>';
                html += '<div class="error">Error: ' + error.message + '</div>';
            }
            
            // Test 3: Check game file
            try {
                html += '<h2>3. Checking Game File</h2>';
                const response = await fetch('index.html');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                
                // Check for our updates
                const hasEssentialUpdate = text.includes('elements-essential.json');
                const hasManifestUpdate = text.includes('elements-database-consolidated.json');
                const hasMergeFunction = text.includes('mergeChunkData');
                
                html += '<div class="success">✓ Game file accessible</div>';
                html += '<ul>';
                html += `<li>Updated to use elements-essential.json: ${hasEssentialUpdate ? '✓' : '✗'}</li>`;
                html += `<li>Loads manifest file: ${hasManifestUpdate ? '✓' : '✗'}</li>`;
                html += `<li>Has merge function: ${hasMergeFunction ? '✓' : '✗'}</li>`;
                html += '</ul>';
                
            } catch (error) {
                html += '<div class="error">✗ Failed to check game file</div>';
                html += '<div class="error">Error: ' + error.message + '</div>';
            }
            
            // Summary
            html += '<h2>Summary</h2>';
            if (window.location.protocol === 'file:') {
                html += '<div class="error">❌ Tests failed because files were opened directly. Please use a web server.</div>';
            } else {
                html += '<div class="success">✅ If all tests passed above, the game should work!</div>';
                html += '<p><a href="index.html">Click here to play Infinite Snake</a></p>';
            }
            
            results.innerHTML = html;
            status.style.display = 'none';
        }
        
        // Run tests
        testDatabase();
    </script>
</body>
</html>